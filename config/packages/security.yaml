security:
    enable_authenticator_manager: true
    
    # üìä HI√âRARCHIE DES R√îLES BUSINESS INTELLIGENCE
    role_hierarchy:
        ROLE_USER:                []
        ROLE_BI_VIEWER:           [ROLE_USER]
        ROLE_BI_ANALYST:          [ROLE_USER, ROLE_BI_VIEWER]
        ROLE_BI_BUILDER:          [ROLE_USER, ROLE_BI_ANALYST]
        ROLE_BI_ADMIN:            [ROLE_USER, ROLE_BI_BUILDER]
        ROLE_EXECUTIVE_VIEWER:    [ROLE_USER, ROLE_BI_VIEWER]
        ROLE_DASHBOARD_MANAGER:   [ROLE_USER, ROLE_BI_BUILDER]
        ROLE_REPORT_SCHEDULER:    [ROLE_USER, ROLE_BI_ANALYST]
        ROLE_DATA_GOVERNOR:       [ROLE_USER, ROLE_BI_ADMIN]
        ROLE_COMPLIANCE_AUDITOR:  [ROLE_USER, ROLE_BI_VIEWER]
        ROLE_KPI_ANALYST:         [ROLE_USER, ROLE_BI_ANALYST]
        ROLE_CHART_DESIGNER:      [ROLE_USER, ROLE_BI_BUILDER]
        ROLE_EXPORT_MANAGER:      [ROLE_USER, ROLE_BI_ANALYST]
        ROLE_REALTIME_MONITOR:    [ROLE_USER, ROLE_BI_VIEWER]
        ROLE_API_CONSUMER:        [ROLE_USER]
        ROLE_WEBHOOK_RECEIVER:    [ROLE_SYSTEM]
        ROLE_ETL_AGENT:           [ROLE_SYSTEM] # üÜï R√¥le pour agents ETL
        ROLE_CUBE_BUILDER:        [ROLE_SYSTEM] # üÜï R√¥le pour construction cubes OLAP
        ROLE_DATA_SYNC_AGENT:     [ROLE_SYSTEM] # üÜï R√¥le pour synchronisation donn√©es
        ROLE_ADMIN:               [ROLE_USER, ROLE_BI_ADMIN, ROLE_DASHBOARD_MANAGER, ROLE_DATA_GOVERNOR]
        ROLE_SUPER_ADMIN:         [ROLE_ADMIN, ROLE_ALLOWED_TO_SWITCH]
        ROLE_SYSTEM:              [ROLE_ADMIN]
        ROLE_SECURITY:            [ROLE_SUPER_ADMIN] # üÜï R√¥le s√©curit√© d√©di√©

    # üîë HASHAGE ULTRA-S√âCURIS√â
    password_hashers:
        Symfony\Component\Security\Core\User\PasswordAuthenticatedUserInterface:
            algorithm: 'sodium' # üÜï Sodium vs bcrypt
            migrate_from: ['bcrypt']

    # üë• PROVIDERS D'AUTHENTIFICATION BI
    providers:
        jwt_users:
            jwt: ~
        security_api_users:
            entity:
                class: ReportingApi\Infrastructure\Security\SecurityApiUser
                property: email
        reporting_api_users:
            entity:
                class: ReportingApi\Infrastructure\Security\ReportingApiUser
                property: email
        webhook_users:
            memory:
                users:
                    webhook_receiver: { password: '%env(WEBHOOK_RECEIVER_SECRET)%', roles: [ROLE_WEBHOOK_RECEIVER] }
        etl_agent_users:
            memory:
                users:
                    etl_agent: { password: '%env(ETL_AGENT_SECRET)%', roles: [ROLE_ETL_AGENT] }
        cube_builder_users:
            memory:
                users:
                    cube_builder: { password: '%env(CUBE_BUILDER_SECRET)%', roles: [ROLE_CUBE_BUILDER] }
        data_sync_users:
            memory:
                users:
                    data_sync: { password: '%env(DATA_SYNC_SECRET)%', roles: [ROLE_DATA_SYNC_AGENT] }
        system_users:
            memory:
                users:
                    system_reporting: { password: '%env(SYSTEM_REPORTING_SECRET)%', roles: [ROLE_SYSTEM] }

    # üõ°Ô∏è FIREWALLS S√âCURIS√âS BI
    firewalls:
        dev:
            pattern: ^/(_(profiler|wdt)|css|images|js)/
            security: false

        # üè• Health Checks - Acc√®s libre
        health:
            pattern: ^/(health|ready|metrics)
            security: false

        # üîÑ Agents ETL - Authentification sp√©cialis√©e
        etl:
            pattern: ^/api/v1/etl
            stateless: true
            custom_authenticators:
                - ReportingApi\Infrastructure\Security\ETLAgentAuthenticator
            entry_point: ReportingApi\Infrastructure\Security\ETLAgentAuthenticator

        # üìä Construction cubes OLAP - Protection ultra-stricte
        cubes:
            pattern: ^/api/v1/cubes
            stateless: true
            custom_authenticators:
                - ReportingApi\Infrastructure\Security\CubeBuilderAuthenticator
            entry_point: ReportingApi\Infrastructure\Security\CubeBuilderAuthenticator

        # üîÑ Synchronisation donn√©es - Authentification stricte
        sync:
            pattern: ^/api/v1/sync
            stateless: true
            custom_authenticators:
                - ReportingApi\Infrastructure\Security\DataSyncAuthenticator
            entry_point: ReportingApi\Infrastructure\Security\DataSyncAuthenticator

        # üì® Webhooks - Protection HMAC ultra-stricte
        webhooks:
            pattern: ^/api/v1/webhooks
            stateless: true
            custom_authenticators:
                - ReportingApi\Infrastructure\Security\WebhookAuthenticator
                - ReportingApi\Infrastructure\Security\HMACAuthenticator
            entry_point: ReportingApi\Infrastructure\Security\WebhookAuthenticator

        # üîê API Syst√®me - Authentification stricte
        system_api:
            pattern: ^/api/v1/system
            stateless: true
            custom_authenticators:
                - ReportingApi\Infrastructure\Security\SystemAuthenticator
            entry_point: ReportingApi\Infrastructure\Security\SystemAuthenticator

        # üìä API Publique Dashboards - Cache + Rate limiting
        public_dashboards:
            pattern: ^/api/v1/dashboards/public
            stateless: true
            security: false # Dashboards publics, s√©curis√© par rate limiting

        # üìä Interface BI Int√©gr√©e - Sessions s√©curis√©es
        bi_interface:
            pattern: ^/bi
            stateless: false
            custom_authenticators:
                - lexik_jwt_authentication.jwt_token_authenticator
                - ReportingApi\Infrastructure\Security\BIInterfaceAuthenticator
            entry_point: lexik_jwt_authentication.jwt_token_authenticator
            
            # üõ°Ô∏è Protection contre les attaques par force brute
            login_throttling:
                max_attempts: 3
                interval: '15 minutes'

        # üîê API Priv√©e - JWT + API Key int√©gr√© security-api
        api:
            pattern: ^/api
            stateless: true
            custom_authenticators:
                - lexik_jwt_authentication.jwt_token_authenticator
                - ReportingApi\Infrastructure\Security\SecurityApiKeyAuthenticator
            entry_point: lexik_jwt_authentication.jwt_token_authenticator

        # üåê Interface Web - Sessions s√©curis√©es
        main:
            lazy: true
            provider: jwt_users
            custom_authenticators:
                - lexik_jwt_authentication.jwt_token_authenticator
            entry_point: lexik_jwt_authentication.jwt_token_authenticator
            
            # üîí Logout s√©curis√©
            logout:
                path: api_logout
                target: api_login

    # üö´ CONTR√îLE D'ACC√àS GRANULAIRE BI
    access_control:
        # ‚úÖ Health checks - Libre
        - { path: ^/(health|ready|metrics), roles: PUBLIC_ACCESS }
        
        # üìä Dashboards publics - Libre (avec rate limiting)
        - { path: ^/api/v1/dashboards/public, roles: PUBLIC_ACCESS }
        
        # üîÑ ETL - Agents autoris√©s
        - { path: ^/api/v1/etl, roles: [ROLE_ETL_AGENT, ROLE_SYSTEM] }
        
        # üìä Cubes OLAP - Agents autoris√©s uniquement
        - { path: ^/api/v1/cubes, roles: [ROLE_CUBE_BUILDER, ROLE_DATA_GOVERNOR, ROLE_SYSTEM] }
        
        # üîÑ Synchronisation - Agents autoris√©s
        - { path: ^/api/v1/sync, roles: [ROLE_DATA_SYNC_AGENT, ROLE_SYSTEM] }
        
        # üì® Webhooks - Services autoris√©s uniquement
        - { path: ^/api/v1/webhooks, roles: [ROLE_WEBHOOK_RECEIVER, ROLE_SYSTEM] }
        
        # üîê API Syst√®me - Syst√®me uniquement
        - { path: ^/api/v1/system, roles: ROLE_SYSTEM }
        
        # üìä Dashboards Overview - Viewers et plus
        - { path: ^/api/v1/dashboards, methods: [GET], roles: [ROLE_BI_VIEWER, ROLE_SYSTEM] }
        - { path: ^/api/v1/dashboards, methods: [POST], roles: [ROLE_BI_BUILDER, ROLE_SYSTEM] }
        - { path: ^/api/v1/dashboards/[^/]+, methods: [PUT, PATCH], roles: [ROLE_DASHBOARD_MANAGER, ROLE_SYSTEM] }
        - { path: ^/api/v1/dashboards/[^/]+, methods: [DELETE], roles: [ROLE_BI_ADMIN, ROLE_SYSTEM] }
        
        # üìà Executive Dashboards - C-Level uniquement
        - { path: ^/api/v1/dashboards/executive, methods: [GET], roles: [ROLE_EXECUTIVE_VIEWER, ROLE_SYSTEM] }
        - { path: ^/api/v1/dashboards/executive, methods: [POST, PUT, PATCH], roles: [ROLE_BI_ADMIN, ROLE_SYSTEM] }
        
        # üìä Reports - Analysts et plus
        - { path: ^/api/v1/reports, methods: [GET], roles: [ROLE_BI_ANALYST, ROLE_SYSTEM] }
        - { path: ^/api/v1/reports, methods: [POST], roles: [ROLE_BI_BUILDER, ROLE_SYSTEM] }
        - { path: ^/api/v1/reports/[^/]+, methods: [PUT, PATCH], roles: [ROLE_BI_BUILDER, ROLE_SYSTEM] }
        - { path: ^/api/v1/reports/[^/]+, methods: [DELETE], roles: [ROLE_BI_ADMIN, ROLE_SYSTEM] }
        
        # üìÖ Scheduled Reports - Schedulers et plus
        - { path: ^/api/v1/reports/scheduled, methods: [GET], roles: [ROLE_REPORT_SCHEDULER, ROLE_SYSTEM] }
        - { path: ^/api/v1/reports/scheduled, methods: [POST, PUT, PATCH], roles: [ROLE_REPORT_SCHEDULER, ROLE_SYSTEM] }
        
        # üìä KPIs - Analysts et plus
        - { path: ^/api/v1/kpis, methods: [GET], roles: [ROLE_KPI_ANALYST, ROLE_SYSTEM] }
        - { path: ^/api/v1/kpis, methods: [POST, PUT, PATCH], roles: [ROLE_KPI_ANALYST, ROLE_SYSTEM] }
        
        # üìà Charts & Visualizations - Designers et plus
        - { path: ^/api/v1/charts, methods: [GET], roles: [ROLE_BI_VIEWER, ROLE_SYSTEM] }
        - { path: ^/api/v1/charts, methods: [POST], roles: [ROLE_CHART_DESIGNER, ROLE_SYSTEM] }
        - { path: ^/api/v1/charts/[^/]+, methods: [PUT, PATCH], roles: [ROLE_CHART_DESIGNER, ROLE_SYSTEM] }
        - { path: ^/api/v1/charts/[^/]+, methods: [DELETE], roles: [ROLE_BI_ADMIN, ROLE_SYSTEM] }
        
        # üì§ Exports - Export managers et plus
        - { path: ^/api/v1/exports, methods: [GET], roles: [ROLE_EXPORT_MANAGER, ROLE_SYSTEM] }
        - { path: ^/api/v1/exports, methods: [POST], roles: [ROLE_EXPORT_MANAGER, ROLE_SYSTEM] }
        
        # üìä Real-time Monitoring - Monitors et plus
        - { path: ^/api/v1/realtime, methods: [GET], roles: [ROLE_REALTIME_MONITOR, ROLE_SYSTEM] }
        
        # üîí Data Governance - Data governors uniquement
        - { path: ^/api/v1/governance, methods: [GET], roles: [ROLE_DATA_GOVERNOR, ROLE_SYSTEM] }
        - { path: ^/api/v1/governance, methods: [POST, PUT, PATCH], roles: [ROLE_DATA_GOVERNOR, ROLE_SYSTEM] }
        
        # üìã Compliance Reports - Auditors et plus
        - { path: ^/api/v1/compliance, methods: [GET], roles: [ROLE_COMPLIANCE_AUDITOR, ROLE_SYSTEM] }
        - { path: ^/api/v1/compliance/reports, methods: [POST], roles: [ROLE_DATA_GOVERNOR, ROLE_SYSTEM] }
        
        # üìä Interface BI - Viewers et plus
        - { path: ^/bi, roles: [ROLE_BI_VIEWER, ROLE_SYSTEM] }
        
        # üîß Administration compl√®te - Admins
        - { path: ^/api/v1/admin, roles: ROLE_ADMIN }
        
        # üõ°Ô∏è S√©curit√© - R√¥le s√©curit√©
        - { path: ^/api/v1/security, roles: ROLE_SECURITY }
        
        # üåê Par d√©faut - Authentifi√©
        - { path: ^/api, roles: IS_AUTHENTICATED_FULLY }
        
        # üè† Interface - Libre
        - { path: ^/, roles: PUBLIC_ACCESS }

    # üî• DURCISSEMENT S√âCURITAIRE BI
    access_decision_manager:
        strategy: unanimous # üÜï Toutes les r√®gles doivent √™tre satisfaites
        allow_if_all_abstain: false
        allow_if_equal_granted_denied: false 